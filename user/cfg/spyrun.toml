# =============================================================================
# File        : spyrun.toml
# Author      : yukimemi
# Last Change : 2024/10/12 00:21:21.
# =============================================================================

[vars]
base_local = '{{ cfg_dir }}\..'
hostname = '{{ env(arg="COMPUTERNAME") }}'
version = '20241012_002121'

funcs = '''
function log {
  param([string]$msg)
  trap { Write-Host "[log] Error $_" }
  $now = Get-Date -f "yyyy/MM/dd HH:mm:ss.fff"
  Write-Host "${now} ${msg}"
}
'''

trap_no_stop = '''
log "spy_name: [{{ spy_name }}]"
$ErrorActionPreference = "Stop"
trap {
  log "{{ spy_name }} Error ! $_"
}
'''

trap_stop = '''
log "spy_name: [{{ spy_name }}]"
$ErrorActionPreference = "Stop"
trap {
  log "{{ spy_name }} Error ! $_"
  "spy_name: [{{ spy_name }}] $_" | Set-Content -Encoding utf8 "{{ stop_path }}"
}
'''

trap_stop_force = '''
log "spy_name: [{{ spy_name }}]"
$ErrorActionPreference = "Stop"
trap {
  log "{{ spy_name }} Error ! $_"
  "spy_name: [{{ spy_name }}] $_" | Set-Content -Encoding utf8 "{{ stop_force_path }}"
}
'''

[cfg]
stop_flg = '{{ base_local }}\stop.flg'

[log]
path = '{{ base_local }}\log\{{ cmd_stem }}.log'
level = 'info'

[init]
cmd = 'powershell'
arg = ['-NoProfile', '-Command', '''& {
  {{ funcs }}
  {{ trap_stop_force }}
  log "{{ version }}"
}''']

# Update cfg toml when there is a change.
[[spys]]
name = 'update_cfg'
input = '{{ cfg_dir }}'
output = '{{ log_dir }}\{{ spy_name }}\{{ event_stem }}'
debounce = 5000
[[spys.patterns]]
pattern = '\.toml$'
cmd = 'powershell'
arg = ['-NoProfile', '-Command', '''& {
  {{ funcs }}
  {{ trap_stop_force }}
  throw "Update config {{ event_path }}"
}''']

# Execute under cmd/all/poll
[[spys]]
name = 'user_all_poll'
input = '{{ base_local }}\cmd\all\poll'
output = '{{ log_dir }}\{{ spy_name }}\{{ event_stem }}'
debounce = 5000
[spys.poll]
interval = 10000
[spys.walk]
delay = [0, 60000]
pattern = '\.cmd$|\.exe$|\.bat$'

# Execute under cmd/all/notify
[[spys]]
name = 'user_all_notify'
input = '{{ base_local }}\cmd\all\notify'
output = '{{ log_dir }}\{{ spy_name }}\{{ event_stem }}'
throttle = 5000
[spys.walk]
delay = [0, 60000]
pattern = '\.cmd$|\.exe$|\.bat$'

# Execute under cmd/host/poll
[[spys]]
name = 'user_host_poll'
input = '{{ base_local }}\cmd\host\poll\{{ hostname }}'
output = '{{ log_dir }}\{{ spy_name }}\{{ event_stem }}'
debounce = 5000
[spys.poll]
interval = 10000
[spys.walk]
delay = [0, 60000]
pattern = '\.cmd$|\.exe$|\.bat$'

# Execute under cmd/host/notify
[[spys]]
name = 'user_host_notify'
input = '{{ base_local }}\cmd\host\notify\{{ hostname }}'
output = '{{ log_dir }}\{{ spy_name }}\{{ event_stem }}'
throttle = 5000
[spys.walk]
delay = [0, 60000]
pattern = '\.cmd$|\.exe$|\.bat$'
