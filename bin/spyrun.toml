# =============================================================================
# File        : spyrun.toml
# Author      : yukimemi
# Last Change : 2024/10/12 17:59:50.
# =============================================================================

[vars]
base_local = '{{ cmd_dir }}\..'
base_local_system = '{{ base_local }}\system'
base_local_user = '{{ base_local }}\user'

base_remote = '{{ psf(arg="init.ps1") }}'
base_remote_system = '{{ base_remote }}\system'
base_remote_user = '{{ base_remote }}\user'

cfg_local_dir_system = '{{ base_local_system }}\cfg'
cfg_local_dir_user = '{{ base_local_user }}\cfg'

cfg_local_path_system = '{{ cfg_local_dir_system }}\{{ cfg_name }}'
cfg_local_path_user = '{{ cfg_local_dir_user }}\{{ cfg_name }}'

cfg_remote_dir = '{{ base_remote }}\bin'
cfg_remote_dir_system = '{{ base_remote_system }}\cfg'
cfg_remote_dir_user = '{{ base_remote_user }}\cfg'

cfg_remote_path = '{{ cfg_remote_dir }}\{{ cfg_name }}'
cfg_remote_path_system = '{{ cfg_remote_dir_system }}\{{ cfg_name }}'
cfg_remote_path_user = '{{ cfg_remote_dir_user }}\{{ cfg_name }}'

cmd_remote_dir = '{{ base_remote }}\bin'
cmd_remote_path = '{{ cmd_remote_dir }}\{{ cmd_name }}'

log_local_dir_system = '{{ base_local_system }}\log'
log_local_dir_user = '{{ base_local_user }}\log'

log_remote_dir = '{{ base_remote }}\log\{{ hostname }}'
log_remote_dir_system = '{{ base_remote_system }}\log\{{ hostname }}'
log_remote_dir_user = '{{ base_remote_user }}\log\{{ hostname }}'

stop_force_path_system = '{{ base_local_system }}\stop_force.flg'
stop_force_path_user = '{{ base_local_user }}\stop_force.flg'

hostname = '{{ env(arg="COMPUTERNAME") }}'

sync_pattern = '\.cmd$|\.toml$|\.exe$|\.ps1$|\.js$|\.bat$|\.json$'
base_file_path = '{{ cmd_dir }}\base.txt'

version = '20241012_175950'

funcs = '''
function log {
  param([string]$msg)
  trap { Write-Host "[log] Error $_" }
  $now = Get-Date -f "yyyy/MM/dd HH:mm:ss.fff"
  Write-Host "${now} ${msg}"
}

'''

z_funcs = '''
function sync_cfg {
  & robocopy /mir "{{ cfg_remote_dir_system }}" "{{ cfg_local_dir_system }}"
  & robocopy /mir "{{ cfg_remote_dir_user }}" "{{ cfg_local_dir_user }}"
}
function sync_cmd {
  & robocopy /mir "{{ base_remote_system }}\cmd\all" "{{ base_local_system }}\cmd\all"
  & robocopy /mir "{{ base_remote_system }}\cmd\host\poll\{{ hostname }}" "{{ base_local_system }}\cmd\host\poll\{{ hostname }}"
  & robocopy /mir "{{ base_remote_system }}\cmd\host\notify\{{ hostname }}" "{{ base_local_system }}\cmd\host\notify\{{ hostname }}"
  & robocopy /mir "{{ base_remote_user }}\cmd\all" "{{ base_local_user }}\cmd\all"
  & robocopy /mir "{{ base_remote_user }}\cmd\host\poll\{{ hostname }}" "{{ base_local_user }}\cmd\host\poll\{{ hostname }}"
  & robocopy /mir "{{ base_remote_user }}\cmd\host\notify\{{ hostname }}" "{{ base_local_user }}\cmd\host\notify\{{ hostname }}"
}
function sync_log {
  & robocopy /e "{{ log_dir }}" "{{ log_remote_dir }}"
  & robocopy /e "{{ log_local_dir_system }}" "{{ log_remote_dir_system }}"
  & robocopy /e "{{ log_local_dir_user }}" "{{ log_remote_dir_user }}"
}
'''

trap_no_stop = '''
log "spy_name: [{{ spy_name }}]"
$ErrorActionPreference = "Stop"
trap {
  log "{{ spy_name }} Error ! $_"
}
'''

trap_stop = '''
log "spy_name: [{{ spy_name }}]"
$ErrorActionPreference = "Stop"
trap {
  log "{{ spy_name }} Error ! $_"
  "spy_name: [{{ spy_name }}] $_" | Set-Content -Encoding utf8 "{{ stop_path }}"
}
'''

trap_stop_force = '''
log "spy_name: [{{ spy_name }}]"
$ErrorActionPreference = "Stop"
trap {
  log "{{ spy_name }} Error ! $_"
  "spy_name: [{{ spy_name }}] $_" | Set-Content -Encoding utf8 "{{ stop_force_path }}"
}
'''

z_init_fn = '''
{{ z_funcs }}
$script:stopFlg = $false
$script:stopFile = ""
$copy = {
  param([string]$local, [string]$remote, [bool]$bin = $false)
  $localHash = (Get-FileHash $local).Hash
  $remoteHash = (Get-FileHash $remote).Hash
  if ($remoteHash -ne $localHash) {
    $script:stopFile = $remote
    if ($bin) {
      $remoteDir = Split-Path -Parent $remote
      log "robocopy ${remoteDir} {{ cmd_dir }} {{ cmd_name }}"
      & cmd /c start "" robocopy $remoteDir "{{ cmd_dir }}" {{ cmd_name }}
      "spy_name: [{{ spy_name }}], cause: [${script:stopFile}] stop system flg is true" | Set-Content -Encoding utf8 "{{ stop_force_path_system }}"
      "spy_name: [{{ spy_name }}], cause: [${script:stopFile}] stop user flg is true" | Set-Content -Encoding utf8 "{{ stop_force_path_user }}"
      Start-Sleep -Seconds 30
      Get-Process | Where-Object { $_.Name -eq "spyrun" } | ForEach-Object { Stop-Process -Force $_.Id }
    } else {
      if ($local -match "_backup") {
        $local = $local.Replace("_backup", "")
        $remote = $remote.Replace("_backup", "")
        $localHash = (Get-FileHash $local).Hash
        if ($localHash -eq $remoteHash) {
          return
        }
      }
      log "${remote} -> ${local}"
      New-Item -Force -ItemType Directory (Split-Path -Parent $local) | Out-Null
      Copy-Item -Force $remote $local
    }
    $script:stopFlg = $true
  }
}
& $copy "{{ cfg_path }}" "{{ cfg_remote_path }}"
& $copy "{{ cmd_path }}" "{{ cmd_remote_path }}" $true
& $copy "{{ cmd_dir }}\common.ps1" "{{ cmd_remote_dir }}\common.ps1"
& $copy "{{ cmd_dir }}\launch.js" "{{ cmd_remote_dir }}\launch.js"
& $copy "{{ cmd_dir }}\init.ps1" "{{ cmd_remote_dir }}\init.ps1"

sync_cfg
sync_cmd
sync_log

if ($script:stopFlg) {
  "spy_name: [{{ spy_name }}], cause: [${script:stopFile}] stop flg is true" | Set-Content -Encoding utf8 "{{ stop_force_path }}"
}

$initFlg = "{{ base_local }}\flg\init_{{ version }}.flg"
if (Test-Path $initFlg) {
  return
}
New-Item -Force -ItemType Directory "{{ base_remote_system }}\cmd\host\poll\{{ hostname }}" | Out-Null
New-Item -Force -ItemType Directory "{{ base_remote_system }}\cmd\host\notify\{{ hostname }}" | Out-Null
New-Item -Force -ItemType Directory "{{ base_remote_user }}\cmd\host\poll\{{ hostname }}" | Out-Null
New-Item -Force -ItemType Directory "{{ base_remote_user }}\cmd\host\notify\{{ hostname }}" | Out-Null
New-Item -Force -ItemType Directory "{{ base_local }}\task\register" | Out-Null
New-Item -Force -ItemType Directory "{{ base_local }}\task\unregister" | Out-Null
New-Item -Force -ItemType Directory "{{ base_local }}\sync" | Out-Null
New-Item -Force -ItemType Directory "{{ log_local_dir_system }}" | Out-Null
New-Item -Force -ItemType Directory "{{ log_local_dir_user }}" | Out-Null

Get-ChildItem -Force -Recurse -File "{{ base_local }}" | ForEach-Object {
  Unblock-File $_.FullName
}
icacls "{{ base_local }}" /grant EveryOne:F /t

New-Item -Force -ItemType File $initFlg | Out-Null
'''

[cfg]
stop_flg = '{{ cmd_dir }}\stop.flg'

[log]
path = '{{ base_local }}\log\{{ cmd_stem }}.log'
level = 'debug'

[init]
cmd = 'powershell'
arg = [
  '-NoProfile',
  '-Command',
  '''& {
  {{ funcs }}
  {{ trap_stop_force }}
  log "{{ version }}"
  function Ensure-ScheduledTask {
    param([string]$uri, [string]$taskPath, [string]$taskName, [string]$repetition, [string]$repetitionStr, [string]$cmd, [string]$arg, [bool]$runas = $true)
    $registered = Get-ScheduledTask | Where-Object { $_.URI -eq $uri }
    if (($null -eq $registered) -or ($registered.Triggers.Repetition.Interval -ne $repetition)) {
      log "Register ScheduledTask ! (${repetition})"
      $now = Get-Date -f "yyyy/MM/dd HH:mm"
      $action = & {
        if ([string]::IsNullOrEmpty($arg)) {
          return New-ScheduledTaskAction -Execute "${cmd}" -WorkingDirectory "{{ cmd_dir }}"
        } else {
          return New-ScheduledTaskAction -Execute "${cmd}" -Argument "${arg}" -WorkingDirectory "{{ cmd_dir }}"
        }
      }
      $trigger = New-ScheduledTaskTrigger -Once -At $now -RepetitionInterval $repetitionStr
      $settings = New-ScheduledTaskSettingsSet -WakeToRun -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -DontStopOnIdleEnd -StartWhenAvailable
      $principal = & {
        if ($runas) {
          return New-ScheduledTaskPrincipal -UserId System -RunLevel Highest
        } else {
          return New-ScheduledTaskPrincipal -GroupId Users
        }
      }
      Register-ScheduledTask -Force -TaskPath $taskPath -TaskName $taskName -Action $action -Trigger $trigger -Settings $settings -Principal $principal
    }
  }

  Ensure-ScheduledTask "\spyrun\spyrun" "\spyrun" "spyrun" "PT5M" "00:05:00" "{{ cmd_path }}" '' $true
  Ensure-ScheduledTask "\spyrun\system\spyrun" "\spyrun\system" "spyrun" "PT5M" "00:05:00" "{{ cmd_path }}" '-c "{{ cfg_local_path_system }}"' $true
  Ensure-ScheduledTask "\spyrun\user\spyrun" "\spyrun\user" "spyrun" "PT5M" "00:05:00" "C:\Windows\system32\wscript.exe" "`"{{ cmd_dir }}\launch.js`" `"{{ cmd_path }}`" -c `"{{ cfg_local_path_user }}`"" $false

  '{{ base_remote }}' | Set-Content -Encoding utf8 '{{ base_file_path }}'
  {{ z_init_fn }}
}''',
]

# Register task
[[spys]]
name = 'register_task'
input = '{{ base_local }}\task\register'
output = '{{ log_remote_dir }}\{{ spy_name }}\{{ event_stem }}'
throttle = 5000
[spys.walk]
pattern = '\.xml$'
[[spys.patterns]]
pattern = '\.xml$'
cmd = 'powershell'
arg = [
  '-NoProfile',
  '-Command',
  '''& {
  {{ funcs }}
  {{ trap_no_stop }}

  log "event_path: {{ event_path }}"
  $xmlStr = [string](Get-Content -Encoding utf8 '{{ event_path }}')
  log "xmlStr: ${xmlStr}"
  $xml = [xml]$xmlStr

  $hash = (Get-FileHash '{{ event_path }}').Hash
  $saveHashPath = '{{ base_local }}\task\hash\{{ event_stem }}.hash'

  Get-ScheduledTask | Where-Object {
    $_.URI -eq $xml.Task.RegistrationInfo.URI
  } | Set-Variable exists

  if ($exists -and (Test-Path $saveHashPath) -and ((Get-Content $saveHashPath).Trim() -eq $hash)) {
    log "Skip Register-ScheduledTask ! hash: ${hash}"
    Remove-Item -Force '{{ event_path }}'
    return
  }

  $part = $xml.Task.RegistrationInfo.URI -split "\\"
  $taskpath = $part[0..($part.Length - 2)] -join "\"
  $taskname = $part[-1]
  log "Register-ScheduledTask ${taskpath}\${taskname} !"
  Register-ScheduledTask -Force -TaskPath $taskpath -TaskName $taskname -Xml $xmlStr | Out-Null

  Get-ScheduledTask | Where-Object {
    $_.URI -eq $xml.Task.RegistrationInfo.URI
  } | Set-Variable check

  if ($null -eq $check) {
    throw "Register-ScheduledTask error ! URI: $($xml.Task.RegistrationInfo.URI)"
  }

  New-Item -Force -ItemType Directory (Split-Path -Parent $saveHashPath) | Out-Null
  $hash | Set-Content -Encoding utf8 $saveHashPath
  Remove-Item -Force '{{ event_path }}'
}''',
]

# UnRegister task
[[spys]]
name = 'unregister_task'
input = '{{ base_local }}\task\unregister'
output = '{{ log_remote_dir }}\{{ spy_name }}\{{ event_stem }}'
throttle = 5000
[spys.walk]
pattern = '\.xml$'
[[spys.patterns]]
pattern = '\.xml$'
cmd = 'powershell'
arg = ['-NoProfile', '-Command', '''& {
  {{ funcs }}
  {{ trap_no_stop }}

  log "event_path: {{ event_path }}"
  $xmlStr = [string](Get-Content -Encoding utf8 '{{ event_path }}')
  log "xmlStr: ${xmlStr}"
  $xml = [xml]$xmlStr

  Get-ScheduledTask | Where-Object {
    $_.URI -eq $xml.Task.RegistrationInfo.URI
  } | Set-Variable exists

  if ($null -eq $exists) {
    log "$($xml.Task.RegistrationInfo.URI) is already removed !"
    Remove-Item -Force '{{ event_path }}'
    return
  }

  $part = $xml.Task.RegistrationInfo.URI -split "\\"
  $taskpath = ($part[0..($part.Length - 2)] -join "\")
  $taskname = $part[-1]
  log "Unregister-ScheduledTask ${taskpath}\${taskname}"

  $removeTasks = {
    param([object]$folder)

    if (![string]::IsNullOrEmpty($taskname)) {
      $folder.GetTasks(1) | Where-Object {
        $folder.Path -eq $taskpath -and $_.Name -eq $taskname
      } | ForEach-Object {
        log "Remove taskpath: [${taskpath}], taskname: [${taskname}]"
        [void]$folder.DeleteTask($_.Name, $null)
      }
    }
    if ([string]::IsNullOrEmpty($taskname)) {
      $folder.GetFolders(1) | ForEach-Object {
        & $removeTasks $_
      }
      $folder.GetTasks(1) | ForEach-Object {
        [void]$folder.DeleteTask($_.Name, $null)
      }
      if ($folder.Path -eq $taskpath -and $taskpath -ne "\") {
        log "Remove taskpath folder: [$taskpath]"
        $sch = New-Object -ComObject Schedule.Service
        [void]$sch.connect()
        $rootFolder = $sch.GetFolder("\")
        [void]$rootFolder.DeleteFolder($taskpath, $null)
      }
    }
  }

  $sch = New-Object -ComObject Schedule.Service
  [void]$sch.connect()
  $folder = $sch.GetFolder($taskpath)
  & $removeTasks $folder

  Remove-Item -Force '{{ event_path }}'
}''']

# Update bin / cfg
[[spys]]
name = 'update_bin'
input = '{{ cmd_remote_dir }}'
output = '{{ log_remote_dir }}\{{ spy_name }}'
debounce = 5000
[[spys.patterns]]
pattern = '{{ sync_pattern }}'
cmd = 'powershell'
arg = ['-NoProfile', '-Command', '''& {
  {{ funcs }}
  {{ trap_stop_force }}
  log "event_path: {{ event_path }}"
  {{ z_init_fn }}
}''']

# Sync
[[spys]]
name = 'sync'
input = '{{ base_local }}\sync'
output = '{{ log_remote_dir }}\{{ spy_name }}\{{ event_stem }}'
debounce = 5000
[spys.walk]
pattern = '\.json$'
[[spys.patterns]]
pattern = '\.json$'
cmd = 'powershell'
arg = [
  '-NoProfile',
  '-Command',
  '''& {
  {{ funcs }}
  {{ z_funcs }}
  {{ trap_no_stop }}
  log "event_path: {{ event_path }}"
  $json = Get-Content -Encoding utf8 '{{ event_path }}'
  log "json: ${json}"
  $cfg = $json | ConvertFrom-Json
  log "src: [$($cfg.src)]"
  log "dst: [$($cfg.dst)]"
  log "type: [$($cfg.type)]"
  log "option: [$($cfg.option)]"
  if (!(Test-Path $cfg.src)) {
    throw "$($cfg.src) is not found !"
  }
  if ($cfg.type -eq "directory") {
    Invoke-Expression "& robocopy $($cfg.option) `"$($cfg.src)`" `"$($cfg.dst)`""
  } elseif ($cfg.type -eq "file") {
    New-Item -Force -ItemType Directory (Split-Path -Parent $cfg.dst) | Out-Null
    Invoke-Expression "Copy-Item $($cfg.option) `"$($cfg.src)`" `"$($cfg.dst)`""
  } else {
    throw "Error `type` must be `file` or `directory` (type: $($cfg.type))"
  }
  Get-ChildItem -Force -Recurse -File $cfg.dst | ForEach-Object {
    Unblock-File $_.FullName
  }
  Remove-Item -Force '{{ event_path }}'
}''',
]

# Sync cfg
[[spys]]
name = 'sync_system_cfg'
input = '{{ cfg_remote_dir_system }}'
output = '{{ log_remote_dir }}\{{ spy_name }}'
debounce = 5000
limitkey = '{{ spy_name }}'
[[spys.patterns]]
pattern = '\.toml$'
cmd = 'powershell'
arg = [
  '-NoProfile',
  '-Command',
  '''& {
  {{ funcs }}
  {{ trap_no_stop }}
  log "event_path: {{ event_path }}"
  [PSCustomObject]@{
    src = "{{ cfg_remote_dir_system }}"
    dst = "{{ cfg_local_dir_system }}"
    type = "directory"
    option = "/e"
  } | ConvertTo-Json | Set-Content -Encoding utf8 '{{ base_local }}\sync\{{ spy_name }}.json'
}''',
]
[[spys]]
name = 'sync_user_cfg'
input = '{{ cfg_remote_dir_user }}'
output = '{{ log_remote_dir }}\{{ spy_name }}'
debounce = 5000
limitkey = '{{ spy_name }}'
[[spys.patterns]]
pattern = '\.toml$'
cmd = 'powershell'
arg = [
  '-NoProfile',
  '-Command',
  '''& {
  {{ funcs }}
  {{ trap_no_stop }}
  log "event_path: {{ event_path }}"
  [PSCustomObject]@{
    src = "{{ cfg_remote_dir_user }}"
    dst = "{{ cfg_local_dir_user }}"
    type = "directory"
    option = "/e"
  } | ConvertTo-Json | Set-Content -Encoding utf8 '{{ base_local }}\sync\{{ spy_name }}.json'
}''',
]

# Sync cmd
[[spys]]
name = 'sync_system_cmd_all'
input = '{{ base_remote_system }}\cmd\all'
output = '{{ log_remote_dir }}\{{ spy_name }}'
recursive = true
debounce = 5000
limitkey = '{{ spy_name }}'
events = ['Create', 'Modify', 'Remove']
[[spys.patterns]]
pattern = '\.cmd$|\.exe$|\.bat$'
cmd = 'powershell'
arg = [
  '-NoProfile',
  '-Command',
  '''& {
  {{ funcs }}
  {{ trap_no_stop }}
  log "event_path: {{ event_path }}"
  [PSCustomObject]@{
    src = "{{ base_remote_system }}\cmd\all"
    dst = "{{ base_local_system }}\cmd\all"
    type = "directory"
    option = "/mir"
  } | ConvertTo-Json | Set-Content -Encoding utf8 '{{ base_local }}\sync\{{ spy_name }}.json'
}''',
]
[[spys]]
name = 'sync_system_cmd_host_poll'
input = '{{ base_remote_system }}\cmd\host\poll\{{ hostname }}'
output = '{{ log_remote_dir }}\{{ spy_name }}'
recursive = true
debounce = 5000
limitkey = '{{ spy_name }}'
events = ['Create', 'Modify', 'Remove']
[[spys.patterns]]
pattern = '\.cmd$|\.exe$|\.bat$'
cmd = 'powershell'
arg = [
  '-NoProfile',
  '-Command',
  '''& {
  {{ funcs }}
  {{ trap_no_stop }}
  log "event_path: {{ event_path }}"
  [PSCustomObject]@{
    src = "{{ base_remote_system }}\cmd\host\poll\{{ hostname }}"
    dst = "{{ base_local_system }}\cmd\host\poll\{{ hostname }}"
    type = "directory"
    option = "/mir"
  } | ConvertTo-Json | Set-Content -Encoding utf8 '{{ base_local }}\sync\{{ spy_name }}.json'
}''',
]
[[spys]]
name = 'sync_system_cmd_host_notify'
input = '{{ base_remote_system }}\cmd\host\notify\{{ hostname }}'
output = '{{ log_remote_dir }}\{{ spy_name }}'
recursive = true
debounce = 5000
limitkey = '{{ spy_name }}'
events = ['Create', 'Modify', 'Remove']
[[spys.patterns]]
pattern = '\.cmd$|\.exe$|\.bat$'
cmd = 'powershell'
arg = [
  '-NoProfile',
  '-Command',
  '''& {
  {{ funcs }}
  {{ trap_no_stop }}
  log "event_path: {{ event_path }}"
  [PSCustomObject]@{
    src = "{{ base_remote_system }}\cmd\host\notify\{{ hostname }}"
    dst = "{{ base_local_system }}\cmd\host\notify\{{ hostname }}"
    type = "directory"
    option = "/mir"
  } | ConvertTo-Json | Set-Content -Encoding utf8 '{{ base_local }}\sync\{{ spy_name }}.json'
}''',
]
[[spys]]
name = 'sync_user_cmd_all'
input = '{{ base_remote_user }}\cmd\all'
output = '{{ log_remote_dir }}\{{ spy_name }}'
recursive = true
debounce = 5000
limitkey = '{{ spy_name }}'
events = ['Create', 'Modify', 'Remove']
[[spys.patterns]]
pattern = '\.cmd$|\.exe$|\.bat$'
cmd = 'powershell'
arg = [
  '-NoProfile',
  '-Command',
  '''& {
  {{ funcs }}
  {{ trap_no_stop }}
  log "event_path: {{ event_path }}"
  [PSCustomObject]@{
    src = "{{ base_remote_user }}\cmd\all"
    dst = "{{ base_local_user }}\cmd\all"
    type = "directory"
    option = "/mir"
  } | ConvertTo-Json | Set-Content -Encoding utf8 '{{ base_local }}\sync\{{ spy_name }}.json'
}''',
]
[[spys]]
name = 'sync_user_cmd_host_poll'
input = '{{ base_remote_user }}\cmd\host\poll\{{ hostname }}'
output = '{{ log_remote_dir }}\{{ spy_name }}'
recursive = true
debounce = 5000
limitkey = '{{ spy_name }}'
events = ['Create', 'Modify', 'Remove']
[[spys.patterns]]
pattern = '\.cmd$|\.exe$|\.bat$'
cmd = 'powershell'
arg = [
  '-NoProfile',
  '-Command',
  '''& {
  {{ funcs }}
  {{ trap_no_stop }}
  log "event_path: {{ event_path }}"
  [PSCustomObject]@{
    src = "{{ base_remote_user }}\cmd\host\poll\{{ hostname }}"
    dst = "{{ base_local_user }}\cmd\host\poll\{{ hostname }}"
    type = "directory"
    option = "/mir"
  } | ConvertTo-Json | Set-Content -Encoding utf8 '{{ base_local }}\sync\{{ spy_name }}.json'
}''',
]

[[spys]]
name = 'sync_user_cmd_host_notify'
input = '{{ base_remote_user }}\cmd\host\notify\{{ hostname }}'
output = '{{ log_remote_dir }}\{{ spy_name }}'
recursive = true
debounce = 5000
limitkey = '{{ spy_name }}'
events = ['Create', 'Modify', 'Remove']
[[spys.patterns]]
pattern = '\.cmd$|\.exe$|\.bat$'
cmd = 'powershell'
arg = [
  '-NoProfile',
  '-Command',
  '''& {
  {{ funcs }}
  {{ trap_no_stop }}
  log "event_path: {{ event_path }}"
  [PSCustomObject]@{
    src = "{{ base_remote_user }}\cmd\host\notify\{{ hostname }}"
    dst = "{{ base_local_user }}\cmd\host\notify\{{ hostname }}"
    type = "directory"
    option = "/mir"
  } | ConvertTo-Json | Set-Content -Encoding utf8 '{{ base_local }}\sync\{{ spy_name }}.json'
}''',
]

# Sync log
[[spys]]
name = 'sync_log_system'
input = '{{ log_local_dir_system }}'
output = '{{ log_remote_dir }}\{{ spy_name }}'
recursive = true
debounce = 60000
limitkey = '{{ spy_name }}'
[[spys.patterns]]
pattern = '\.log$'
cmd = 'powershell'
arg = [
  '-NoProfile',
  '-Command',
  '''& {
  {{ funcs }}
  {{ trap_no_stop }}
  log "event_path: {{ event_path }}"
  [PSCustomObject]@{
    src = "{{ log_local_dir_system }}"
    dst = "{{ log_remote_dir_system }}"
    type = "directory"
    option = "/e /r:1 /w:1"
  } | ConvertTo-Json | Set-Content -Encoding utf8 '{{ base_local }}\sync\{{ spy_name }}.json'
}''',
]
[[spys]]
name = 'sync_log_user'
input = '{{ log_local_dir_user }}'
output = '{{ log_remote_dir }}\{{ spy_name }}'
recursive = true
debounce = 60000
limitkey = '{{ spy_name }}'
[[spys.patterns]]
pattern = '\.log$'
cmd = 'powershell'
arg = [
  '-NoProfile',
  '-Command',
  '''& {
  {{ funcs }}
  {{ trap_no_stop }}
  log "event_path: {{ event_path }}"
  [PSCustomObject]@{
    src = "{{ log_local_dir_user }}"
    dst = "{{ log_remote_dir_user }}"
    type = "directory"
    option = "/e /r:1 /w:1"
  } | ConvertTo-Json | Set-Content -Encoding utf8 '{{ base_local }}\sync\{{ spy_name }}.json'
}''',
]
